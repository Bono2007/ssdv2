---

- name: Launch Pretask
  include_tasks: "{{ settings.source }}/includes/dockerapps/pretasks/stremiobase.yml"

- name: Check if stremio-postgres container exists
  command: docker ps -a --filter "name=stremio-postgres" --format "{% raw %}{{.Names}}{% endraw %}"
  register: stremio_postgres_container
  changed_when: false

- name: Check if stremio-redis container exists
  command: docker ps -a --filter "name=stremio-redis" --format "{% raw %}{{.Names}}{% endraw %}"
  register: stremio_redis_container
  changed_when: false

- name: Fail if stremio-redis container does not exist
  fail:
    msg: "The stremio-redis container does not exist. Please ensure it is running before proceeding."
  when: stremio_redis_container.stdout == ""

- name: Check if databases exist
  command: docker exec stremio-postgres psql -U stremio -lqt | cut -d \| -f 1 | grep -qw {{ item }}
  register: db_check
  changed_when: false
  failed_when: false
  loop:
    - zilean
    - streamfusion

- name: Create missing databases
  command: docker exec -e PGPASSWORD=stremio stremio-postgres psql -U stremio -c "CREATE DATABASE {{ item }};"
  when: db_check.results | selectattr('item', 'equalto', item) | map(attribute='rc') | first != 0
  loop:
    - zilean
    - streamfusion

- name: Create a volume for zilean
  docker_volume:
    name: data-zilean

- name: Deploy zilean container
  community.docker.docker_container:
    name: zilean
    image: ipromknight/zilean:latest
    env:
      Zilean__Database__ConnectionString: "Host=stremio-postgres;Port=5432;Database=zilean;Username=stremio;Password=stremio"
      Zilean__Dmm__ImportBatched: "true"
      Zilean__Imdb__EnableImportMatching: "false"
      Zilean__Imdb__EnableEndpoint: "false"
      Zilean__Dmm__MaxFilteredResults: "200"
      Zilean__Dmm__MinimumScoreMatch: "0.85"
    volumes:
      - data-zilean:/app/data
    restart_policy: always
    networks:
      - name: traefik_proxy

- name: Prompt for SECRET_API_KEY
  pause:
    prompt: "Enter SECRET_API_KEY"
    echo: no
  register: secret_api_key