- name: Creating paths
  become: yes
  file: "path={{item}} state=directory mode=0775 owner={{ lookup('env','MYUID') }} group={{ lookup('env','MYGID') }}"
  with_items:
    - "/home/{{ lookup('env','USER') }}/usenet"
    - "{{ settings.storage }}/docker/{{ lookup('env','USER') }}/usenet"
    - "{{ settings.storage }}/docker/{{ lookup('env','USER') }}/usenet/config"
    - "{{ settings.storage }}/docker/{{ lookup('env','USER') }}/usenet/nzbs"      
      
- name: Obtenir l'adresse IP du conteneur Traefik
  shell: docker exec traefik ip -o -4 addr show eth0 | grep -Po 'inet \K[\d.]+'
  register: traefik_ip_result
  ignore_errors: yes

- set_fact:
    traefik_ip: "{{ traefik_ip_result.stdout }}"

- set_fact:
    new_ip_address: "{{ traefik_ip.split('.')[:-1] | join('.') }}.249"

- name: Create config.yaml
  file:
    path: "{{ settings.storage }}/docker/{{ lookup('env','USER') }}/usenet/config/config.yaml"
    state: touch

- name: Modify config.yaml
  blockinfile:
    path: "{{ settings.storage }}/docker/{{ lookup('env','USER') }}/usenet/config/config.yaml"
    block: |
      root_path: /nzbs
      webdav_port: 8080
      api_port: 8081
      db_path: /config/usenet-drive.db
      rclone:
        vfs_url: http://{{ new_ip_address }}:5573
      usenet:
        download:
          max_download_workers: 15
          providers:
            - host: post.otherusenet.server
              port: 119
              username: pepe
              password: 1234
              tls: false
              max_connections: 25
        upload:
          groups:
            - alt.binaries.movee
            - alt.binaries.teevee
          file_allow_list:
            - .mkv.bin
            - .mp4.bin
          providers:
            - host: my.usenet.server
              port: 80
              username: pepe
              password: 1234
              ttl: true
              max_connections: 49


